<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatlings - User Hub</title>
    <link rel="stylesheet" href="/user/components/shared-header-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
        }


        /* Guide Modal */
        .guide-content {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .guide-content h3 {
            color: #667eea;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .guide-content h3:first-child {
            margin-top: 0;
        }

        .guide-content p {
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
        }

        .guide-content ul {
            margin-left: 20px;
            margin-bottom: 20px;
            line-height: 1.8;
        }

        .guide-content li {
            margin-bottom: 10px;
        }

        .guide-image-placeholder {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            color: #667eea;
            font-style: italic;
            margin: 20px 0;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 1200px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
        }

        .modal-close:hover {
            transform: scale(1.2);
        }

        .welcome-section {
            text-align: center;
            padding: 40px 0;
        }

        .welcome-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .welcome-section p {
            color: #666;
            font-size: 1.2em;
            line-height: 1.6;
            max-width: 700px;
            margin: 0 auto 30px;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1em;
        }

        .section-divider {
            margin: 40px 0;
            border-top: 2px solid rgba(102, 126, 234, 0.2);
        }

        .section-title {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 600;
        }

        .species-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
        }

        .species-card:hover {
            transform: translateY(-2px);
        }

        .species-count {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .species-name {
            color: #666;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <script src="/user/components/shared-header.js"></script>
    <div class="container">
        <script>initSharedHeader('home');</script>

        <!-- Daily Visit Notification -->
        <div id="daily-visit-notification" style="display: none; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border: 2px solid #667eea; border-radius: 15px; padding: 20px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 1.3em; color: #667eea; font-weight: bold; margin-bottom: 10px;">
                üéâ Daily Visit!
            </div>
            <div id="daily-visit-message" style="font-size: 1em; color: #333; margin-bottom: 15px;">
                A chatling visited you today!
            </div>
            <button onclick="document.getElementById('daily-visit-notification').style.display='none'" style="background: #667eea; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                Got it!
            </button>
        </div>

        <div class="content">
            <div class="welcome-section">
                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-discovered">0</div>
                        <div class="stat-label">Total Chatlings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-achievements">0</div>
                        <div class="stat-label">Achievements</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-points">0</div>
                        <div class="stat-label">Points Earned</div>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">Collection by Rarity</h3>
                    <div id="rarity-breakdown" class="quick-stats" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-legendary" style="color: #f39c12;">0</div>
                            <div class="stat-label">‚≠ê Legendary</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-epic" style="color: #9b59b6;">0</div>
                            <div class="stat-label">üíé Epic</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-rare" style="color: #3498db;">0</div>
                            <div class="stat-label">üí† Rare</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-uncommon" style="color: #27ae60;">0</div>
                            <div class="stat-label">‚ú® Uncommon</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-common" style="color: #95a5a6;">0</div>
                            <div class="stat-label">Common</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Current Chatling -->
    <div id="chatling-modal" class="modal" onclick="closeChatlingModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closeChatlingModal()">&times;</span>
            <div style="padding: 30px;">
                <h1 style="text-align: center; color: #667eea; font-size: 2em; margin-bottom: 30px;" id="modal-creature-name">Your Current Chatling</h1>

                <div class="creature-display">
                    <div class="image-with-traits">
                        <div class="rarity-badge" id="modal-rarity-badge" style="display: none;"></div>
                        <img id="modal-creature-image" class="creature-image" src="" alt="Creature" style="display: none;">
                        <div class="traits-column" id="modal-traits-container">
                            <div class="loading">Loading traits...</div>
                        </div>
                        <div class="loading" id="modal-image-loading">Loading image...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guide-modal" class="modal" onclick="closeGuideModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closeGuideModal()">&times;</span>
            <div style="padding: 30px;">
                <h1 style="text-align: center; color: #667eea; font-size: 2em; margin-bottom: 30px;">How Chatlings Works</h1>

                <div class="guide-content">
                    <h3>üéØ Getting Started</h3>
                    <p>Chatlings is a unique creature collection game that rewards you for engaging with YouTube content. Each liked video generates a special chatling that you can claim and add to your collection.</p>

                    <h3>üîó Step 1: Connect Your YouTube Account</h3>
                    <p>Navigate to the <strong>Integrations</strong> page and connect your YouTube account. This allows Chatlings to monitor your liked videos and generate rewards for you.</p>
                    <div class="guide-image-placeholder">[Image: Integrations page showing YouTube connect button]</div>

                    <h3>‚ù§Ô∏è Step 2: Like Videos on YouTube</h3>
                    <p>Browse YouTube as you normally would and like videos that you enjoy. Each liked video will generate a unique chatling based on the video's content and metadata.</p>
                    <ul>
                        <li>Each video creates a unique chatling</li>
                        <li>Chatlings are available to claim for 24 hours</li>
                        <li>The same video can generate different chatlings over time</li>
                    </ul>

                    <h3>üéÅ Step 3: Claim Your Rewards</h3>
                    <p>Return to the Chatlings dashboard to see your available rewards. Click on the <strong>Integrations</strong> page to check for new chatlings and claim them to add them to your collection.</p>
                    <div class="guide-image-placeholder">[Image: Rewards page showing claimable chatlings]</div>

                    <h3>üëæ Understanding Your Chatlings</h3>
                    <p>Each chatling is unique and has several key attributes:</p>
                    <ul>
                        <li><strong>Name & Species:</strong> Every chatling has a unique name and belongs to a specific species</li>
                        <li><strong>Rarity:</strong> Ranges from Common to Legendary, affecting how special your chatling is</li>
                        <li><strong>Trait Scores:</strong> 8 social dimensions that define your chatling's personality</li>
                        <li><strong>Appearance:</strong> A unique AI-generated image representing your chatling</li>
                    </ul>
                    <div class="guide-image-placeholder">[Image: Chatling card showing name, rarity, and traits]</div>

                    <h3>üìä The 8 Social Traits</h3>
                    <p>Each chatling has scores (0-10) across 8 social dimensions that reflect the video's content:</p>
                    <ul>
                        <li><strong>üé≠ Theatricality:</strong> How dramatic and expressive the chatling is</li>
                        <li><strong>üí° Intellect:</strong> Knowledge and analytical thinking</li>
                        <li><strong>üé® Creativity:</strong> Innovation and artistic expression</li>
                        <li><strong>üë• Social:</strong> Friendliness and social engagement</li>
                        <li><strong>‚ö° Energy:</strong> Activity level and enthusiasm</li>
                        <li><strong>üòå Calm:</strong> Composure and tranquility</li>
                        <li><strong>üéØ Focus:</strong> Concentration and determination</li>
                        <li><strong>üåà Quirky:</strong> Uniqueness and unconventional behavior</li>
                    </ul>

                    <h3>üèÜ Rarity Tiers</h3>
                    <p>Chatlings come in five rarity tiers, each with different levels of uniqueness:</p>
                    <ul>
                        <li><strong>‚≠ê Legendary:</strong> Extremely rare and special</li>
                        <li><strong>üíé Epic:</strong> Very uncommon with exceptional traits</li>
                        <li><strong>üí† Rare:</strong> Notable and harder to find</li>
                        <li><strong>‚ú® Uncommon:</strong> Less common with interesting features</li>
                        <li><strong>Common:</strong> Standard chatlings that are easier to find</li>
                    </ul>

                    <h3>üìö Your Collection</h3>
                    <p>Visit the <strong>Collections</strong> page to view all your claimed chatlings. You can:</p>
                    <ul>
                        <li>Filter by rarity and platform</li>
                        <li>Sort by most recent, rarity, name, or encounter count</li>
                        <li>Click on any chatling to view its full details</li>
                        <li>See trait scores and personality breakdown</li>
                    </ul>
                    <div class="guide-image-placeholder">[Image: Collections page showing grid of chatlings]</div>

                    <h3>üéñÔ∏è Achievements</h3>
                    <p>Complete challenges and milestones to earn achievements. Track your progress on the <strong>Achievements</strong> page.</p>

                    <h3>üí¨ Current Chatling</h3>
                    <p>Your current chatling appears in the header next to your avatar. Click on it to view its full details, including its complete trait breakdown and high-resolution image.</p>
                    <div class="guide-image-placeholder">[Image: Current chatling modal with full view]</div>

                    <h3>üîî Notifications</h3>
                    <p>Click the bell icon in the header to view your notifications, including daily visits and new chatlings available to claim.</p>

                    <h3>‚ùì Need Help?</h3>
                    <p>If you have questions or encounter issues, check back here or reach out through the support channels. Happy collecting!</p>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="/user/components/creature-card-styles.css">
    <script src="/user/components/creature-card-script.js"></script>

    <script>
        let currentCreatureId = null;

        // Modal functions
        function openChatlingModal() {
            if (!currentCreatureId) return;

            const modal = document.getElementById('chatling-modal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Load creature details
            loadChatlingDetails(currentCreatureId);
        }

        function closeChatlingModal(event) {
            if (event && event.target.className !== 'modal' && event.target.className !== 'modal-close') {
                return;
            }
            const modal = document.getElementById('chatling-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function loadChatlingDetails(creatureId) {
            try {
                const response = await fetch(`/api/creature/${creatureId}/details`);
                if (!response.ok) {
                    throw new Error('Failed to fetch creature details');
                }

                const data = await response.json();

                // Update modal title
                document.getElementById('modal-creature-name').textContent = data.creature_name;

                // Update rarity badge
                const rarityBadge = document.getElementById('modal-rarity-badge');
                if (data.rarity_tier) {
                    rarityBadge.textContent = data.rarity_tier;
                    rarityBadge.className = 'rarity-badge rarity-' + data.rarity_tier.toLowerCase();
                    rarityBadge.style.display = 'block';
                }

                // Update image
                const img = document.getElementById('modal-creature-image');
                const imgLoading = document.getElementById('modal-image-loading');
                img.src = `/images/${data.selected_image}`;
                img.style.display = 'block';
                imgLoading.style.display = 'none';

                // Render traits using the reusable component
                const container = document.getElementById('modal-traits-container');
                container.id = 'traits-container';
                const tempImgId = document.getElementById('modal-creature-image').id;
                document.getElementById('modal-creature-image').id = 'creature-image';
                document.getElementById('modal-image-loading').id = 'image-loading';

                // Add overall score badge before rendering traits
                const imageWithTraits = document.querySelector('#chatling-modal .image-with-traits');
                console.log('Image with traits container:', imageWithTraits);
                console.log('Overall score from API:', data.overall_score);

                if (imageWithTraits && data.overall_score !== undefined) {
                    // Remove existing overall score badge if any
                    const existingBadge = imageWithTraits.querySelector('.overall-score-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }

                    const scoreBadge = document.createElement('div');
                    scoreBadge.className = 'overall-score-badge ' + getScoreClassForBadge(data.overall_score);
                    scoreBadge.innerHTML = `<span>‚≠ê</span><span>${data.overall_score}</span>`;
                    imageWithTraits.appendChild(scoreBadge);
                    console.log('Score badge added:', scoreBadge);
                    console.log('Badge classes:', scoreBadge.className);
                } else {
                    console.log('Failed to add badge - imageWithTraits:', !!imageWithTraits, 'score:', data.overall_score);
                }

                window.renderTraitsVertical(data.traits, data.primary_color);

                // Restore IDs
                document.getElementById('creature-image').id = tempImgId;
                document.getElementById('image-loading').id = 'modal-image-loading';
                container.id = 'modal-traits-container';

            } catch (error) {
                console.error('Error loading chatling details:', error);
            }
        }

        function getScoreClassForBadge(score) {
            if (score >= 95) return 'score-max';
            if (score >= 81) return 'score-vhigh';
            if (score >= 61) return 'score-high';
            if (score >= 41) return 'score-medium';
            if (score >= 21) return 'score-low';
            return 'score-vlow';
        }

        // Guide modal functions - Home page version
        function openGuideModal() {
            const modal = document.getElementById('guide-modal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeGuideModal(event) {
            if (event && event.target.className !== 'modal' && event.target.className !== 'modal-close') {
                return;
            }
            const modal = document.getElementById('guide-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Check if user is logged in and load their stats
        async function loadUserData() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const user = await response.json();
                    loadUserStats();
                    checkDailyVisitNotification();
                } else {
                    // User not logged in - redirect to login
                    window.location.href = '/user/login.html';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                window.location.href = '/user/login.html';
            }
        }

        // Check for daily visit notification from login
        function checkDailyVisitNotification() {
            const dailyVisit = sessionStorage.getItem('dailyVisit');
            if (dailyVisit) {
                const visit = JSON.parse(dailyVisit);
                const message = visit.wasNewDiscovery
                    ? `${visit.chatlingName} visited you today! This is a new chatling in your collection!`
                    : `${visit.chatlingName} visited you today!`;

                document.getElementById('daily-visit-message').textContent = message;
                document.getElementById('daily-visit-notification').style.display = 'block';

                // Clear the stored notification
                sessionStorage.removeItem('dailyVisit');
            }
        }

        async function loadUserStats() {
            try {
                const response = await fetch('/api/user/stats');
                if (response.ok) {
                    const stats = await response.json();

                    // Store stats globally for dropdown
                    window.currentUserStats = stats;

                    // Update top stats
                    document.getElementById('total-discovered').textContent = stats.total_rewards || 0;
                    document.getElementById('total-achievements').textContent = stats.total_achievements || 0;
                    document.getElementById('total-points').textContent = stats.total_points || 0;

                    // Update rarity breakdown with "count/total" format
                    const rarityMap = {
                        'Legendary': 'rarity-legendary',
                        'Epic': 'rarity-epic',
                        'Rare': 'rarity-rare',
                        'Uncommon': 'rarity-uncommon',
                        'Common': 'rarity-common'
                    };

                    // Create a map of user's counts
                    const userCounts = {};
                    if (stats.rarity_breakdown) {
                        stats.rarity_breakdown.forEach(item => {
                            userCounts[item.rarity_tier] = item;
                        });
                    }

                    // Update each rarity with "count/total" format
                    Object.keys(rarityMap).forEach(tier => {
                        const elementId = rarityMap[tier];
                        const el = document.getElementById(elementId);
                        if (el) {
                            const count = userCounts[tier] ? userCounts[tier].count : 0;
                            const total = userCounts[tier] ? userCounts[tier].total : (stats.rarity_totals && stats.rarity_totals[tier] ? stats.rarity_totals[tier] : 0);
                            el.textContent = `${count}/${total}`;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load data on page load
        loadUserData();
    </script>
</body>
</html>
