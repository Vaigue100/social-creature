<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatlings - User Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        nav {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-link {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .nav-link.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .welcome-section {
            text-align: center;
            padding: 40px 0;
        }

        .welcome-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .welcome-section p {
            color: #666;
            font-size: 1.2em;
            line-height: 1.6;
            max-width: 700px;
            margin: 0 auto 30px;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1em;
        }

        .section-divider {
            margin: 40px 0;
            border-top: 2px solid rgba(102, 126, 234, 0.2);
        }

        .section-title {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 600;
        }

        .species-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
        }

        .species-card:hover {
            transform: translateY(-2px);
        }

        .species-count {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .species-name {
            color: #666;
            font-size: 1em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="/admin/assets/logo.png" alt="Chatlings Logo" style="max-width: 200px; margin-bottom: 20px;">
            <h1>Chatlings</h1>
            <p class="subtitle">Collect chatlings as you explore YouTube!</p>
        </header>

        <div id="user-info" class="user-info" style="display: none;">
            <div class="user-avatar" id="user-avatar">?</div>
            <div style="flex: 1;">
                <strong id="username">Guest</strong>
                <div style="font-size: 0.9em; color: #666;" id="current-chatling-text">
                    Loading...
                </div>
            </div>
            <div id="current-chatling-card" style="display: none; text-align: center; padding: 10px; background: rgba(255, 255, 255, 0.5); border-radius: 8px; min-width: 120px;">
                <img id="chatling-image" src="" alt="Current Chatling" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; margin-bottom: 5px;">
                <div style="font-size: 0.85em; font-weight: bold; color: #667eea;" id="chatling-name">-</div>
                <div style="font-size: 0.75em; color: #999;" id="chatling-rarity">-</div>
                <a href="current-chatling.html" style="display: inline-block; margin-top: 8px; padding: 5px 12px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; font-size: 0.75em;">View Details</a>
            </div>
        </div>

        <nav>
            <div class="nav-links">
                <a href="index.html" class="nav-link active">Home</a>
                <a href="collections.html" class="nav-link">Collections</a>
                <a href="achievements.html" class="nav-link">Achievements</a>
                <a href="integrations.html" class="nav-link">Integrations</a>
                <a href="notifications.html" class="nav-link">Notifications</a>
            </div>
        </nav>

        <!-- Daily Visit Notification -->
        <div id="daily-visit-notification" style="display: none; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border: 2px solid #667eea; border-radius: 15px; padding: 20px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 1.3em; color: #667eea; font-weight: bold; margin-bottom: 10px;">
                üéâ Daily Visit!
            </div>
            <div id="daily-visit-message" style="font-size: 1em; color: #333; margin-bottom: 15px;">
                A chatling visited you today!
            </div>
            <button onclick="document.getElementById('daily-visit-notification').style.display='none'" style="background: #667eea; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                Got it!
            </button>
        </div>

        <div class="content">
            <div class="welcome-section">
                <h2>Welcome to Chatlings!</h2>
                <p>
                    Discover and collect unique chatlings from your liked YouTube videos!
                    Each video has its own chatling that lasts for 24 hours.
                    Like videos on YouTube, then connect to claim your rewards!
                </p>

                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-discovered">0</div>
                        <div class="stat-label">Total Chatlings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-achievements">0</div>
                        <div class="stat-label">Achievements</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-points">0</div>
                        <div class="stat-label">Points Earned</div>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">Collection by Rarity</h3>
                    <div id="rarity-breakdown" class="quick-stats" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-legendary" style="color: #f39c12;">0</div>
                            <div class="stat-label">‚≠ê Legendary</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-epic" style="color: #9b59b6;">0</div>
                            <div class="stat-label">üíé Epic</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-rare" style="color: #3498db;">0</div>
                            <div class="stat-label">üí† Rare</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-uncommon" style="color: #27ae60;">0</div>
                            <div class="stat-label">‚ú® Uncommon</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="rarity-common" style="color: #95a5a6;">0</div>
                            <div class="stat-label">Common</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in and load their stats
        async function loadUserData() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const user = await response.json();
                    updateUserInfo(user);
                    loadUserStats();
                    checkDailyVisitNotification();
                } else {
                    // User not logged in - redirect to login
                    window.location.href = '/user/login.html';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                window.location.href = '/user/login.html';
            }
        }

        // Check for daily visit notification from login
        function checkDailyVisitNotification() {
            const dailyVisit = sessionStorage.getItem('dailyVisit');
            if (dailyVisit) {
                const visit = JSON.parse(dailyVisit);
                const message = visit.wasNewDiscovery
                    ? `${visit.chatlingName} visited you today! This is a new chatling in your collection!`
                    : `${visit.chatlingName} visited you today!`;

                document.getElementById('daily-visit-message').textContent = message;
                document.getElementById('daily-visit-notification').style.display = 'block';

                // Clear the stored notification
                sessionStorage.removeItem('dailyVisit');
            }
        }

        function updateUserInfo(user) {
            document.getElementById('user-info').style.display = 'flex';
            document.getElementById('username').textContent = user.username;
            document.getElementById('user-avatar').textContent = user.username.charAt(0).toUpperCase();

            // Update current chatling display
            if (user.currentChatling) {
                const chatling = user.currentChatling;
                document.getElementById('current-chatling-text').textContent = `Your current chatling: ${chatling.name}`;

                // Show chatling card
                document.getElementById('current-chatling-card').style.display = 'block';
                document.getElementById('chatling-image').src = `/images/${chatling.image}`;
                document.getElementById('chatling-name').textContent = chatling.shortName || chatling.name;
                document.getElementById('chatling-rarity').textContent = chatling.rarityTier || 'Unknown';
            } else {
                document.getElementById('current-chatling-text').textContent = 'No chatling assigned yet';
                document.getElementById('current-chatling-card').style.display = 'none';
            }
        }

        async function loadUserStats() {
            try {
                const response = await fetch('/api/user/stats');
                if (response.ok) {
                    const stats = await response.json();

                    // Update top stats
                    document.getElementById('total-discovered').textContent = stats.total_rewards || 0;
                    document.getElementById('total-achievements').textContent = stats.total_achievements || 0;
                    document.getElementById('total-points').textContent = stats.total_points || 0;

                    // Update rarity breakdown with "count/total" format
                    const rarityMap = {
                        'Legendary': 'rarity-legendary',
                        'Epic': 'rarity-epic',
                        'Rare': 'rarity-rare',
                        'Uncommon': 'rarity-uncommon',
                        'Common': 'rarity-common'
                    };

                    // Create a map of user's counts
                    const userCounts = {};
                    if (stats.rarity_breakdown) {
                        stats.rarity_breakdown.forEach(item => {
                            userCounts[item.rarity_tier] = item;
                        });
                    }

                    // Update each rarity with "count/total" format
                    Object.keys(rarityMap).forEach(tier => {
                        const elementId = rarityMap[tier];
                        const el = document.getElementById(elementId);
                        if (el) {
                            const count = userCounts[tier] ? userCounts[tier].count : 0;
                            const total = userCounts[tier] ? userCounts[tier].total : (stats.rarity_totals && stats.rarity_totals[tier] ? stats.rarity_totals[tier] : 0);
                            el.textContent = `${count}/${total}`;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load data on page load
        loadUserData();
    </script>
</body>
</html>
