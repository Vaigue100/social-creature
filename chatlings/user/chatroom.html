<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatroom - Chatlings</title>
  <link rel="stylesheet" href="components/shared-header-styles.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .content-wrapper {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }

    .tab-button {
      background: transparent;
      color: #666;
      border: none;
      border-bottom: 3px solid transparent;
      padding: 12px 24px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s;
      position: relative;
      font-weight: 600;
    }

    .tab-button:hover {
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-button .badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #e74c3c;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75em;
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Conversation Card */
    .conversation-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .conversation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .conversation-topic {
      flex: 1;
    }

    .conversation-topic h3 {
      color: #667eea;
      font-size: 1.3em;
      margin-bottom: 5px;
    }

    .conversation-meta {
      color: #999;
      font-size: 0.9em;
    }

    .unread-badge {
      background: #e74c3c;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: bold;
    }

    /* Participants */
    .participants {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .participant {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      padding: 10px 15px;
      border-radius: 10px;
    }

    .participant-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #667eea;
    }

    .participant-info {
      flex: 1;
    }

    .participant-name {
      font-weight: bold;
      color: #333;
      font-size: 0.95em;
    }

    .mood-indicator {
      font-size: 0.85em;
      padding: 2px 8px;
      border-radius: 8px;
      display: inline-block;
      margin-top: 3px;
    }

    .mood-happy {
      background: #d4edda;
      color: #155724;
    }

    .mood-neutral {
      background: #fff3cd;
      color: #856404;
    }

    .mood-unhappy {
      background: #f8d7da;
      color: #721c24;
    }

    /* Chat Messages */
    .chat-messages {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      min-height: 300px;
    }

    .chat-message {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      opacity: 0;
      animation: fadeInMessage 0.5s forwards;
    }

    @keyframes fadeInMessage {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }

    .message-content {
      flex: 1;
    }

    .message-author {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 4px;
      font-size: 0.9em;
    }

    .message-text {
      background: white;
      padding: 12px 16px;
      border-radius: 12px;
      color: #333;
      line-height: 1.5;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .message-text.positive {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }

    .message-text.negative {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
    }

    .message-text.neutral {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .typing-dots {
      background: white;
      padding: 12px 20px;
      border-radius: 12px;
      display: flex;
      gap: 5px;
    }

    .typing-dots span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
      animation: typing 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.7;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    /* Conversation History */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .history-item {
      background: white;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .history-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .history-topic {
      color: #667eea;
      font-weight: bold;
    }

    .history-date {
      color: #999;
      font-size: 0.85em;
    }

    .history-preview {
      color: #666;
      font-size: 0.9em;
    }

    /* Runaway Section */
    .runaway-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .runaway-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .runaway-image {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 15px;
      border: 4px solid #e74c3c;
      opacity: 0.7;
    }

    .runaway-name {
      font-weight: bold;
      color: #333;
      font-size: 1.1em;
      margin-bottom: 10px;
    }

    .runaway-info {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 15px;
    }

    .difficulty-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 0.85em;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .difficulty-easy {
      background: #d4edda;
      color: #155724;
    }

    .difficulty-normal {
      background: #fff3cd;
      color: #856404;
    }

    .difficulty-hard {
      background: #f8d7da;
      color: #721c24;
    }

    .recover-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      transition: all 0.3s;
      width: 100%;
    }

    .recover-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 4em;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.5em;
      margin-bottom: 10px;
      color: #666;
    }

    .empty-state p {
      font-size: 1em;
      max-width: 500px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Generate Button */
    .generate-button {
      background: #28a745;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      transition: all 0.3s;
      margin: 20px 0;
      width: 100%;
    }

    .generate-button:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    /* Loading Spinner */
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      text-align: center;
      color: #999;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <script src="components/shared-header.js"></script>

  <div class="container">
    <script>initSharedHeader('chatroom');</script>

    <div class="content-wrapper">
      <!-- Tabs -->
    <div class="tabs">
      <button class="tab-button active" onclick="switchTab('latest')">
        Latest Conversation
      </button>
      <button class="tab-button" onclick="switchTab('history')">
        History
      </button>
      <button class="tab-button" onclick="switchTab('runaways')" id="runaways-tab">
        Runaways
        <span class="badge" id="runaway-count" style="display: none;">0</span>
      </button>
    </div>

    <!-- Latest Conversation Tab -->
    <div id="latest-tab" class="tab-content active">
      <button class="generate-button" onclick="generateConversation()">
        üé≤ Generate New Conversation (Test)
      </button>

      <div id="latest-conversation-container"></div>
    </div>

    <!-- History Tab -->
    <div id="history-tab" class="tab-content">
      <div class="conversation-card">
        <h3 style="color: #667eea; margin-bottom: 20px;">Conversation History</h3>
        <div id="history-list" class="history-list"></div>
      </div>
    </div>

    <!-- Runaways Tab -->
    <div id="runaways-tab-content" class="tab-content">
      <div class="conversation-card">
        <h3 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Runaway Chatlings</h3>
        <p style="color: #666; margin-bottom: 20px;">These chatlings became unhappy and left. Try to recover them!</p>
        <div id="runaways-list" class="runaway-list"></div>
      </div>
    </div>
    </div>
  </div>

  <script>
    let conversations = [];
    let runaways = [];
    let currentlyAnimating = false;

    // Initialize
    async function init() {
      await loadConversations();
      await loadRunaways();
    }

    // Switch tabs
    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tab}-tab${tab === 'runaways' ? '-content' : ''}`).classList.add('active');
    }

    // Load conversations
    async function loadConversations() {
      try {
        const response = await fetch('/api/chatroom/conversations');
        conversations = await response.json();

        if (conversations.length > 0) {
          displayLatestConversation(conversations[0]);
          displayHistory();
        } else {
          showEmptyState();
        }
      } catch (error) {
        console.error('Error loading conversations:', error);
      }
    }

    // Load runaways
    async function loadRunaways() {
      try {
        const response = await fetch('/api/chatroom/runaways');
        runaways = await response.json();

        const badge = document.getElementById('runaway-count');
        if (runaways.length > 0) {
          badge.textContent = runaways.length;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }

        displayRunaways();
      } catch (error) {
        console.error('Error loading runaways:', error);
      }
    }

    // Display latest conversation with animation
    function displayLatestConversation(conversation) {
      const container = document.getElementById('latest-conversation-container');

      if (!conversation.messages || conversation.messages.length === 0) {
        showEmptyState();
        return;
      }

      const moodImpact = conversation.mood_impact || {};

      const html = `
        <div class="conversation-card">
          <div class="conversation-header">
            <div class="conversation-topic">
              <h3>${conversation.topic_text}</h3>
              <div class="conversation-meta">
                ${new Date(conversation.created_at).toLocaleString()} ‚Ä¢ ${conversation.participant_count} participants
              </div>
            </div>
            ${!conversation.is_read ? '<span class="unread-badge">NEW</span>' : ''}
          </div>

          <div class="participants" id="participants-${conversation.id}"></div>

          <div class="chat-messages" id="messages-${conversation.id}"></div>
        </div>
      `;

      container.innerHTML = html;

      // Display participants
      const participantsContainer = document.getElementById(`participants-${conversation.id}`);
      const uniqueParticipants = {};

      conversation.messages.forEach(msg => {
        if (!uniqueParticipants[msg.creature_id]) {
          uniqueParticipants[msg.creature_id] = {
            id: msg.creature_id,
            name: msg.creature_name,
            image: msg.creature_image
          };
        }
      });

      Object.values(uniqueParticipants).forEach(p => {
        let mood = 'neutral';
        if (moodImpact.happy && moodImpact.happy.includes(p.id)) mood = 'happy';
        if (moodImpact.unhappy && moodImpact.unhappy.includes(p.id)) mood = 'unhappy';

        const moodEmoji = mood === 'happy' ? 'üòä' : mood === 'unhappy' ? 'üòû' : 'üòê';

        participantsContainer.innerHTML += `
          <div class="participant">
            <img src="/images/${p.image}" alt="${p.name}" class="participant-avatar">
            <div class="participant-info">
              <div class="participant-name">${p.name}</div>
              <span class="mood-indicator mood-${mood}">${moodEmoji} ${mood}</span>
            </div>
          </div>
        `;
      });

      // Animate messages
      animateConversation(conversation);

      // Mark as read
      if (!conversation.is_read) {
        markAsRead(conversation.id);
      }
    }

    // Animate conversation messages
    async function animateConversation(conversation) {
      if (currentlyAnimating) return;
      currentlyAnimating = true;

      const messagesContainer = document.getElementById(`messages-${conversation.id}`);
      messagesContainer.innerHTML = '';

      for (let i = 0; i < conversation.messages.length; i++) {
        const message = conversation.messages[i];

        // Show typing indicator (except for first message)
        if (i > 0) {
          const typingHtml = `
            <div class="typing-indicator" id="typing-${i}">
              <img src="/images/${message.creature_image}" alt="${message.creature_name}" class="message-avatar">
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          `;
          messagesContainer.innerHTML += typingHtml;

          // Wait for typing
          await sleep(1500);

          // Remove typing indicator
          document.getElementById(`typing-${i}`)?.remove();
        }

        // Show message
        const messageHtml = `
          <div class="chat-message">
            <img src="/images/${message.creature_image}" alt="${message.creature_name}" class="message-avatar">
            <div class="message-content">
              <div class="message-author">${message.creature_name}</div>
              <div class="message-text ${message.sentiment || 'neutral'}">
                ${message.message_text}
              </div>
            </div>
          </div>
        `;
        messagesContainer.innerHTML += messageHtml;

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Wait before next message
        await sleep(1000);
      }

      currentlyAnimating = false;
    }

    // Display history
    function displayHistory() {
      const historyList = document.getElementById('history-list');

      if (conversations.length === 0) {
        historyList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <h3>No Conversations Yet</h3>
            <p>Your chatlings haven't had any conversations yet. Check back later!</p>
          </div>
        `;
        return;
      }

      historyList.innerHTML = conversations.map(conv => {
        const preview = conv.messages && conv.messages.length > 0
          ? `${conv.messages[0].creature_name}: ${conv.messages[0].message_text}`
          : 'No messages';

        return `
          <div class="history-item" onclick="viewConversation('${conv.id}')">
            <div class="history-item-header">
              <div class="history-topic">${conv.topic_text}</div>
              <div class="history-date">${new Date(conv.created_at).toLocaleDateString()}</div>
            </div>
            <div class="history-preview">${preview.substring(0, 100)}...</div>
          </div>
        `;
      }).join('');
    }

    // Display runaways
    function displayRunaways() {
      const runawaysList = document.getElementById('runaways-list');

      if (runaways.length === 0) {
        runawaysList.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="empty-state-icon">üéâ</div>
            <h3>No Runaways!</h3>
            <p>All your chatlings are happy and staying with you!</p>
          </div>
        `;
        return;
      }

      runawaysList.innerHTML = runaways.map(runaway => {
        const successRate = runaway.recovery_difficulty === 'easy' ? '80%'
          : runaway.recovery_difficulty === 'normal' ? '50%' : '20%';

        return `
          <div class="runaway-card">
            <img src="/images/${runaway.selected_image}" alt="${runaway.creature_name}" class="runaway-image">
            <div class="runaway-name">${runaway.creature_name}</div>
            <div class="runaway-info">
              Ran away ${new Date(runaway.ran_away_at).toLocaleDateString()}<br>
              After ${runaway.unhappy_count} unhappy conversations
            </div>
            <div class="difficulty-badge difficulty-${runaway.recovery_difficulty}">
              ${runaway.recovery_difficulty.toUpperCase()} (${successRate} success)
            </div>
            <button class="recover-button" onclick="recoverRunaway('${runaway.creature_id}')">
              Try to Recover
            </button>
          </div>
        `;
      }).join('');
    }

    // View specific conversation
    function viewConversation(conversationId) {
      const conversation = conversations.find(c => c.id === conversationId);
      if (conversation) {
        switchTab('latest');
        displayLatestConversation(conversation);
      }
    }

    // Recover runaway
    async function recoverRunaway(creatureId) {
      if (!confirm('Attempt to recover this chatling? Success is not guaranteed.')) {
        return;
      }

      try {
        const response = await fetch(`/api/chatroom/recover/${creatureId}`, {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          alert(`‚úÖ ${result.message}`);
          await loadRunaways();
        } else {
          alert(`‚ùå ${result.message}`);
          if (result.newDifficulty) {
            await loadRunaways(); // Refresh to show updated difficulty
          }
        }

      } catch (error) {
        console.error('Error recovering runaway:', error);
        alert('Error attempting recovery. Please try again.');
      }
    }

    // Generate conversation (for testing)
    async function generateConversation() {
      const button = event.target;
      button.disabled = true;
      button.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 3px; margin: 0 auto;"></div>';

      try {
        const response = await fetch('/api/chatroom/generate', {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          alert('‚úÖ ' + result.message);
          await loadConversations();
          await loadRunaways(); // Refresh in case anyone ran away
        } else {
          alert('‚ö†Ô∏è ' + result.message);
        }

      } catch (error) {
        console.error('Error generating conversation:', error);
        alert('Error generating conversation');
      } finally {
        button.disabled = false;
        button.innerHTML = 'üé≤ Generate New Conversation (Test)';
      }
    }

    // Mark conversation as read
    async function markAsRead(conversationId) {
      try {
        await fetch(`/api/chatroom/mark-read/${conversationId}`, {
          method: 'POST'
        });
      } catch (error) {
        console.error('Error marking as read:', error);
      }
    }

    // Show empty state
    function showEmptyState() {
      const container = document.getElementById('latest-conversation-container');
      container.innerHTML = `
        <div class="conversation-card">
          <div class="empty-state">
            <div class="empty-state-icon">üí≠</div>
            <h3>No Conversations Yet</h3>
            <p>Your chatlings haven't had any conversations yet. Conversations happen 1-2 times per day automatically. You can also generate one manually using the button above for testing!</p>
          </div>
        </div>
      `;
    }

    // Helper: sleep
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
