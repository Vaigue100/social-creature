<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>View Chatling</title>

    <!-- PWA manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#667eea">

    <!-- Apple iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chatlings">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">

    <script src="/user/config.js"></script>
  <script src="/user/components/auth-check.js"></script>
    <link rel="stylesheet" href="/user/components/creature-card-styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .back-button:hover {
            transform: translateY(-2px);
        }

        .creature-card-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }

        .creature-title {
            text-align: center;
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .error {
            text-align: center;
            color: #c00;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div style="max-width: 1200px; margin: 0 auto;">
        <a href="collections.html" class="back-button">‚Üê Back to Collection</a>

        <div class="creature-card-container">
            <div class="creature-display">
                <div class="image-with-traits">
                    <div class="rarity-badge" id="rarity-badge" style="display: none;"></div>
                    <div class="overall-score-badge" id="overall-score-badge" style="display: none; cursor: pointer;" title="Click to view traits"></div>
                    <div class="name-badge" id="name-badge" style="display: none;"></div>
                    <div class="bodytype-badge" id="bodytype-badge" style="display: none; cursor: pointer;" title="Click to view body type lore"></div>
                    <img id="creature-image" class="creature-image" src="" alt="Creature" style="display: none;">
                    <div class="loading" id="image-loading">Loading image...</div>

                    <!-- Creature Lore attached to bottom -->
                    <div class="creature-lore-section" id="creature-lore-section" style="display: none;">
                        <h3 style="color: #9b59b6; margin-bottom: 10px; font-size: 1.1em;">üìñ <span id="creature-lore-title">Tale</span></h3>
                        <p id="creature-lore" style="color: #666; line-height: 1.6; margin: 0;">
                            Loading creature lore...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Body Type Lore Modal -->
        <div id="bodytype-modal" class="lore-modal" style="display: none;">
            <div class="lore-modal-content">
                <span class="lore-modal-close" data-modal="bodytype-modal">&times;</span>
                <h2 style="color: #2ecc71; margin-bottom: 15px;">üé® <span id="bodytype-modal-title">Body Type</span> Lineage</h2>
                <p id="bodytype-modal-lore" style="color: #666; line-height: 1.8;">
                    Loading body type lore...
                </p>
            </div>
        </div>

        <!-- Traits Modal -->
        <div id="traits-modal" class="lore-modal" style="display: none;">
            <div class="lore-modal-content">
                <span class="lore-modal-close" data-modal="traits-modal">&times;</span>
                <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">
                    <span id="traits-modal-title">Chatling</span> Traits
                </h2>
                <div id="traits-modal-container" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Traits will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script src="/user/components/creature-card-script.js"></script>
    <script>
        async function loadChatling() {
            try {
                // Get creature ID from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const creatureId = urlParams.get('id');

                if (!creatureId) {
                    document.getElementById('creature-name').textContent = 'No Chatling Selected';
                    document.getElementById('subtitle').textContent = '';
                    document.getElementById('image-loading').textContent = 'Please select a chatling from your collection.';
                    document.getElementById('image-loading').className = 'error';
                    return;
                }

                // Load creature details with traits
                const creatureResponse = await fetch(`/api/creature/${creatureId}/details`);
                if (!creatureResponse.ok) {
                    throw new Error('Failed to fetch creature details');
                }

                const data = await creatureResponse.json();

                // Update rarity badge (top-right)
                const rarityBadge = document.getElementById('rarity-badge');
                if (data.rarity_tier) {
                    rarityBadge.textContent = data.rarity_tier;
                    rarityBadge.className = 'rarity-badge rarity-' + data.rarity_tier.toLowerCase();
                    rarityBadge.style.display = 'block';
                }

                // Update name badge (bottom-left)
                const nameBadge = document.getElementById('name-badge');
                if (data.creature_name) {
                    nameBadge.textContent = data.creature_name;
                    nameBadge.style.display = 'block';
                }

                // Update body type badge (bottom-right)
                const bodytypeBadge = document.getElementById('bodytype-badge');
                if (data.body_type_name) {
                    bodytypeBadge.textContent = data.body_type_name;
                    bodytypeBadge.style.display = 'block';

                    // Store body type lore in modal (for popup)
                    document.getElementById('bodytype-modal-title').textContent = data.body_type_name;
                    document.getElementById('bodytype-modal-lore').textContent = `The ${data.body_type_name} are a fascinating lineage of Chatlings known for their unique characteristics. These creatures embody specific traits that make them stand out in the world of Social Streams. Their distinctive form reflects the type of content and community energy from which they emerged.`;
                }

                // Update creature-specific lore with trait-based content
                if (data.creature_name) {
                    document.getElementById('creature-lore-title').textContent = `${data.creature_name}'s`;
                    document.getElementById('creature-lore').textContent = `${data.creature_name} is a unique Chatling with an overall power level of ${data.overall_score || 'unknown'}. This remarkable being possesses a distinctive combination of social traits that define its personality and behavior in the realm of Social Streams. Born from the energy of its source content, ${data.creature_name} carries the essence of that moment forever.`;

                    // Show the creature lore section
                    document.getElementById('creature-lore-section').style.display = 'block';
                }

                // Update image
                const img = document.getElementById('creature-image');
                const imgLoading = document.getElementById('image-loading');
                img.src = `${getImageUrl(data.selected_image)}`;
                img.style.display = 'block';
                imgLoading.style.display = 'none';

                // Update overall score badge (top-left)
                const scoreBadge = document.getElementById('overall-score-badge');
                if (data.overall_score !== undefined) {
                    scoreBadge.className = 'overall-score-badge ' + getScoreClassForBadge(data.overall_score);
                    scoreBadge.innerHTML = `<span>‚≠ê</span><span>${data.overall_score}</span>`;
                    scoreBadge.style.display = 'block';
                }

                // Store traits data for modal
                window.currentCreatureData = {
                    name: data.creature_name,
                    traits: data.traits,
                    primaryColor: data.primary_color
                };

            } catch (error) {
                console.error('Error loading chatling:', error);
                document.getElementById('creature-name').textContent = 'Error Loading Chatling';
                document.getElementById('subtitle').textContent = '';
                document.getElementById('image-loading').textContent = 'Failed to load chatling details.';
                document.getElementById('image-loading').className = 'error';
            }
        }

        function getScoreClassForBadge(score) {
            if (score >= 95) return 'score-max';
            if (score >= 81) return 'score-vhigh';
            if (score >= 61) return 'score-high';
            if (score >= 41) return 'score-medium';
            if (score >= 21) return 'score-low';
            return 'score-vlow';
        }

        // Modal click handlers
        document.addEventListener('click', (e) => {
            const bodytypeBadge = document.getElementById('bodytype-badge');
            const bodytypeModal = document.getElementById('bodytype-modal');
            const scoreBadge = document.getElementById('overall-score-badge');
            const traitsModal = document.getElementById('traits-modal');

            // Open body type modal when badge is clicked
            if (e.target === bodytypeBadge) {
                bodytypeModal.style.display = 'flex';
            }

            // Open traits modal when score badge is clicked
            if (e.target === scoreBadge || e.target.parentElement === scoreBadge) {
                openTraitsModal();
            }

            // Close modal when X is clicked
            if (e.target.classList.contains('lore-modal-close')) {
                const modalId = e.target.getAttribute('data-modal');
                document.getElementById(modalId).style.display = 'none';
            }

            // Close modal when clicking outside the content
            if (e.target.classList.contains('lore-modal')) {
                e.target.style.display = 'none';
            }
        });

        // Function to open traits modal and render traits
        function openTraitsModal() {
            if (!window.currentCreatureData) return;

            const modal = document.getElementById('traits-modal');
            const container = document.getElementById('traits-modal-container');
            const title = document.getElementById('traits-modal-title');

            // Update title
            title.textContent = window.currentCreatureData.name || 'Chatling';

            // Clear previous traits
            container.innerHTML = '';

            // Render traits in modal
            const traits = window.currentCreatureData.traits || [];
            traits.forEach(trait => {
                const traitDiv = document.createElement('div');
                traitDiv.className = 'trait-modal-item';
                traitDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: rgba(102, 126, 234, 0.08); border-radius: 10px; transition: background 0.2s;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5em;">${trait.icon || '‚≠ê'}</span>
                            <div>
                                <div style="font-weight: 600; color: #333; font-size: 1em;">${trait.category_name}</div>
                                <div style="font-size: 0.85em; color: #666; margin-top: 2px;">${trait.description || ''}</div>
                            </div>
                        </div>
                        <div style="font-weight: bold; font-size: 1.2em; color: #667eea; min-width: 40px; text-align: right;">
                            ${trait.score}
                        </div>
                    </div>
                `;
                container.appendChild(traitDiv);
            });

            // Show modal
            modal.style.display = 'flex';
        }

        // Load on page load
        loadChatling();
    </script>
</body>
</html>
