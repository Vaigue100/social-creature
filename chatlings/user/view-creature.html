<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>View Chatling - Chatlings</title>

    <!-- PWA manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#667eea">

    <!-- Apple iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chatlings">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">

    <!-- Shared styles and scripts -->
    <link rel="stylesheet" href="/user/components/shared-header-styles.css?v=2">
    <link rel="stylesheet" href="/user/components/creature-card-full.css?v=1">
    <script src="/user/config.js"></script>
    <script src="/user/components/auth-check.js"></script>
    <script src="/user/components/creature-card-renderer.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: white;
            font-size: 1.5em;
            margin: 0;
        }

        .close-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .content {
            padding: 30px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        /* Welcome animation overlay */
        #welcome-animation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #welcome-animation-overlay video {
            max-width: 90%;
            max-height: 90%;
            width: auto;
            height: auto;
        }
    </style>
</head>
<body>
    <!-- Welcome animation overlay -->
    <div id="welcome-animation-overlay">
        <video id="welcome-animation-video" playsinline></video>
    </div>

    <div class="container">
        <div class="header">
            <h1 id="page-title">View Chatling</h1>
            <button class="close-button" onclick="goBack()" title="Close">√ó</button>
        </div>

        <div class="content">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading creature...</p>
            </div>

            <div id="creature-container" style="display: none;">
                <!-- Creature card will be inserted here -->
            </div>

            <div id="error-container" style="display: none;">
                <!-- Error message will be shown here -->
            </div>
        </div>
    </div>

    <script>
        let currentCreatureId = null;
        let currentUserId = null;
        let returnPath = null;

        // Get query parameters
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                id: params.get('id'),
                showWelcome: params.get('showWelcome') === 'true',
                from: params.get('from') || 'collections'
            };
        }

        // Go back to previous page
        function goBack() {
            const params = getQueryParams();

            // Return to the page we came from
            if (params.from === 'daily-box') {
                window.location.href = '/user/daily-box.html';
            } else if (params.from === 'team') {
                window.location.href = '/user/team.html';
            } else if (params.from === 'home') {
                window.location.href = '/user/index.html';
            } else {
                window.location.href = '/user/collections.html';
            }
        }

        // Play welcome animation
        async function playWelcomeAnimation(bodyTypeName) {
            return new Promise((resolve) => {
                const animationPath = `/animations/welcome/${bodyTypeName.toLowerCase()}.mp4`;
                const overlay = document.getElementById('welcome-animation-overlay');
                const video = document.getElementById('welcome-animation-video');

                console.log('üé¨ Checking for welcome animation:', animationPath);

                // Test if animation exists
                const testVideo = document.createElement('video');
                testVideo.onloadeddata = () => {
                    console.log('‚úÖ Animation found, playing...');

                    // Show overlay and play animation
                    overlay.style.display = 'flex';
                    video.src = animationPath;
                    video.currentTime = 0;

                    video.onloadeddata = () => {
                        video.play().catch(err => {
                            console.error('Error playing animation:', err);
                            overlay.style.display = 'none';
                            resolve();
                        });
                    };

                    video.onended = () => {
                        console.log('‚úÖ Animation ended');
                        overlay.style.display = 'none';
                        resolve();
                    };

                    video.onerror = () => {
                        console.error('Error loading animation');
                        overlay.style.display = 'none';
                        resolve();
                    };

                    // Timeout fallback (10 seconds)
                    setTimeout(() => {
                        if (overlay.style.display !== 'none') {
                            console.log('‚è±Ô∏è Animation timeout');
                            overlay.style.display = 'none';
                            resolve();
                        }
                    }, 10000);
                };

                testVideo.onerror = () => {
                    console.log('‚ùå No animation found, skipping');
                    resolve();
                };

                testVideo.src = animationPath;
            });
        }

        // Load and display creature
        async function loadCreature() {
            const params = getQueryParams();

            if (!params.id) {
                showError('No creature ID specified');
                return;
            }

            currentCreatureId = params.id;

            try {
                // Ensure creature card renderer is loaded
                if (!window.creatureCardRenderer) {
                    throw new Error('Creature card renderer not loaded');
                }

                // Get current user ID
                const userResponse = await fetch('/api/user/profile');
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    currentUserId = userData.id;
                }

                // Play welcome animation first if requested
                if (params.showWelcome) {
                    console.log('üé¨ Welcome animation requested');

                    // Fetch creature data to get body type name
                    const creatureResponse = await fetch(`/api/creature/${currentCreatureId}/details`);
                    if (creatureResponse.ok) {
                        const creature = await creatureResponse.json();
                        if (creature.body_type_name) {
                            console.log('Body type:', creature.body_type_name);
                            await playWelcomeAnimation(creature.body_type_name);
                        }
                    }
                }

                // Render creature card using the reusable component
                const cardHtml = await window.creatureCardRenderer.renderCard(
                    currentCreatureId,
                    currentUserId,
                    {
                        cardId: 'view-creature-card',
                        includeVideo: false,
                        maxHeight: '500px',
                        isCarousel: false
                    }
                );

                // Insert card HTML
                const container = document.getElementById('creature-container');
                container.innerHTML = cardHtml;

                // Initialize card interactions
                window.creatureCardRenderer.initializeCard('view-creature-card');

                // Update page title
                const creatureResponse = await fetch(`/api/creature/${currentCreatureId}/details`);
                if (creatureResponse.ok) {
                    const creature = await creatureResponse.json();
                    document.getElementById('page-title').textContent = creature.creature_name || 'View Chatling';
                }

                // Hide loading, show creature
                document.getElementById('loading').style.display = 'none';
                container.style.display = 'block';

            } catch (error) {
                console.error('Error loading creature:', error);
                showError(`Failed to load creature: ${error.message}`);
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
            errorContainer.style.display = 'block';
        }

        // Initialize on page load
        window.addEventListener('load', loadCreature);
    </script>
</body>
</html>
