<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chatlings - Integrations</title>

    <!-- PWA manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#667eea">

    <!-- Apple iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chatlings">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">

    <script src="/user/config.js"></script>
  <script src="/user/components/auth-check.js"></script>
    <link rel="stylesheet" href="/user/components/shared-header-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .integration-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .integration-icon {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            flex-shrink: 0;
        }

        .integration-icon.youtube {
            background: #FF0000;
            color: white;
        }

        .integration-details {
            flex: 1;
        }

        .integration-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .integration-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .integration-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-connected {
            background: #27ae60;
            color: white;
        }

        .status-disconnected {
            background: #e0e0e0;
            color: #666;
        }

        .integration-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .connection-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .connection-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        }

        .connection-info-item:last-child {
            border-bottom: none;
        }

        .connection-info-label {
            font-weight: 600;
            color: #666;
        }

        .connection-info-value {
            color: #333;
        }

        .how-it-works {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .how-it-works h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .how-it-works ol {
            margin-left: 20px;
            line-height: 1.8;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <script src="/user/components/shared-header.js"></script>
    <div class="container">
        <script>initSharedHeader('integrations');</script>

        <div class="content">
            <div class="integration-card">
                <div class="integration-icon youtube">ðŸ“º</div>
                <div class="integration-details">
                    <div class="integration-title">YouTube Likes</div>
                    <div class="integration-description">
                        Connect your YouTube account to claim chatlings from videos you've liked!
                        Each video has a unique chatling that lasts for 24 hours. Privacy-first: no data is stored.
                    </div>

                    <div id="youtube-status-message" style="margin: 15px 0; padding: 15px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 10px; display: none;">
                        <div style="font-weight: 600; margin-bottom: 5px;">Last Session</div>
                        <div id="rewards-claimed-msg"></div>
                    </div>

                    <div id="youtube-status" style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 10px; display: none;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #667eea;">ðŸ¤– Community Ambassador Status</div>
                        <div id="auto-check-status" style="color: #666; font-size: 0.95em;">Checking for new Chatlings...</div>
                    </div>

                    <div class="integration-actions">
                        <button id="connect-youtube-btn" class="btn btn-primary" onclick="connectYouTube()">
                            Connect YouTube to Find Chatlings
                        </button>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-left: 4px solid #667eea; border-radius: 5px;">
                        <strong style="color: #667eea;">ðŸ¤– Automatic Checking</strong>
                        <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #666;">
                            You must log in at least once every 24 hours to keep automatic checking active.
                        </p>
                    </div>
                </div>
            </div>

            <div class="how-it-works">
                <h3>How It Works</h3>

                <div style="margin-top: 25px; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                    <p style="line-height: 1.7; color: #555; margin: 0;">
                        Your Community Ambassador loves exploring! They'll visit the social circles around videos you like and make friends with the chatlings hanging out there.
                        <strong>Stay active</strong> to keep your Ambassador energized, and they'll notify you whenever they've befriended new chatlings for your collection! ðŸŽ‰
                    </p>
                </div>

                <h3 style="margin-top: 30px;">Privacy</h3>
                <ul style="line-height: 1.8; color: #666;">
                    <li>We only check which videos you've liked - nothing else</li>
                    <li>We store a refresh token to enable background checking</li>
                    <li>No video history or watch data is viewed or stored</li>
                    <li>No chat is viewed or stored</li>
                    <li>You can disconnect anytime through your Google account settings</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guide-modal" class="modal" onclick="closeGuideModal(event)" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);">
        <div class="modal-content" onclick="event.stopPropagation()" style="position: relative; background: white; margin: 2% auto; padding: 30px; width: 90%; max-width: 800px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <span class="modal-close" onclick="closeGuideModal()" style="position: absolute; top: 15px; right: 20px; color: #667eea; font-size: 35px; font-weight: bold; cursor: pointer;">&times;</span>
            <h1 style="text-align: center; color: #667eea; font-size: 2em; margin-bottom: 30px;">Integrations Guide</h1>

            <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                <h3 style="color: #667eea; margin-top: 0; margin-bottom: 15px;">How It Works</h3>
                <ol style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8; color: #333;">
                    <li><strong>Like videos on YouTube</strong> that you enjoy</li>
                    <li><strong>Click "Connect YouTube to Find Chatlings"</strong> once</li>
                    <li><strong>Discover new chatlings</strong> - each with their own unique personality!</li>
                </ol>

                <div style="margin: 25px 0; padding: 20px; background: rgba(102, 126, 234, 0.05); border-radius: 10px; border-left: 4px solid #667eea;">
                    <p style="line-height: 1.7; color: #555; margin: 0;">
                        Your Community Ambassador loves exploring! They'll visit the social circles around videos you like and make friends with the chatlings hanging out there.
                        <strong>Stay active</strong> to keep your Ambassador energized, and they'll notify you whenever they've befriended new chatlings for your collection! ðŸŽ‰
                    </p>
                </div>

                <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">Privacy</h3>
                <ul style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8; color: #333;">
                    <li>We only check which videos you've liked - nothing else</li>
                    <li>We store a refresh token to enable background checking</li>
                    <li>No video history or watch data is viewed or stored</li>
                    <li>No chat is viewed or stored</li>
                    <li>You can disconnect anytime through your Google account settings</li>
                </ul>

                <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">Shared Chatlings</h3>
                <p style="line-height: 1.6; color: #333; margin-bottom: 15px;">
                    If another user likes the same video, they might meet the same chatling! This creates a fun shared experience while maintaining your privacy.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Guide modal functions
        function openGuideModal() {
            const modal = document.getElementById('guide-modal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeGuideModal(event) {
            if (event && event.target.id !== 'guide-modal' && event.target.className !== 'modal-close') {
                return;
            }
            const modal = document.getElementById('guide-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
    </script>

    <script>
        let hasIntegrated = false;

        async function connectYouTube() {
            const btn = document.getElementById('connect-youtube-btn');
            btn.disabled = true;
            btn.textContent = 'Connecting...';

            try {
                // Initiate OAuth flow
                const response = await fetch('/api/auth/youtube/authorize');
                if (response.ok) {
                    const data = await response.json();
                    // Redirect to Google OAuth
                    window.location.href = data.authUrl;
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to initiate YouTube connection');
                    btn.disabled = false;
                    btn.textContent = hasIntegrated ? 'Community Ambassador Exploring' : 'Connect YouTube to Find Chatlings';
                }
            } catch (error) {
                console.error('Error connecting YouTube:', error);
                alert('Error connecting to YouTube. Make sure you\'re logged in.');
                btn.disabled = false;
                btn.textContent = hasIntegrated ? 'Check for New Chatlings' : 'Connect YouTube to Find Chatlings';
            }
        }

        async function checkIntegrationStatus() {
            try {
                // Check if youtube_integrated_at is set by looking for URL params from previous integration
                // If user has successfully integrated before, they'll have been redirected with rewards_claimed param
                const hasIntegratedBefore = localStorage.getItem('youtube_integrated');

                if (hasIntegratedBefore === 'true') {
                    hasIntegrated = true;
                    const btn = document.getElementById('connect-youtube-btn');
                    btn.textContent = 'Community Ambassador Exploring';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }
            } catch (error) {
                console.error('Error checking integration status:', error);
            }
        }

        // Check for OAuth callback with results
        const urlParams = new URLSearchParams(window.location.search);
        const rewardsClaimed = urlParams.get('rewards_claimed');
        const error = urlParams.get('error');

        if (rewardsClaimed !== null) {
            // Mark as integrated
            localStorage.setItem('youtube_integrated', 'true');

            const statusMsg = document.getElementById('youtube-status-message');
            const rewardsMsg = document.getElementById('rewards-claimed-msg');

            if (parseInt(rewardsClaimed) > 0) {
                rewardsMsg.innerHTML = `
                    <strong style="color: #27ae60;">Success!</strong>
                    You claimed <strong>${rewardsClaimed}</strong> new chatling${parseInt(rewardsClaimed) > 1 ? 's' : ''} from your liked videos!
                    <br><a href="collections.html" style="color: #667eea; text-decoration: none;">View your collection â†’</a>
                `;
                statusMsg.style.display = 'block';
            } else {
                rewardsMsg.innerHTML = `
                    <strong style="color: #f39c12;">No New Rewards</strong>
                    You've already claimed rewards from your recently liked videos.
                    Like more videos and try again!
                `;
                statusMsg.style.display = 'block';
            }

            // Update button to show integrated state
            hasIntegrated = true;
            const btn = document.getElementById('connect-youtube-btn');
            btn.textContent = 'Community Ambassador Exploring';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');

            // Clean URL
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (error) {
            alert('Error: ' + error);
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // ========================================
        // Server-side checking status update
        // ========================================
        async function updateYouTubeStatus() {
            // Check if current user is connected to YouTube
            const tokenResponse = await fetch('/api/youtube/token');
            const tokenData = await tokenResponse.json();

            if (tokenData.connected) {
                // Show status indicating server-side checking is active
                const statusDiv = document.getElementById('youtube-status');
                if (statusDiv) {
                    statusDiv.style.display = 'block';
                }

                // Update button to show checking is active
                hasIntegrated = true;
                const btn = document.getElementById('connect-youtube-btn');
                btn.textContent = 'âœ“ Connected - Server checks every 15 minutes';
                btn.disabled = true;
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                btn.style.cursor = 'not-allowed';

                // Update status text
                const statusText = document.getElementById('auto-check-status');
                if (statusText) {
                    statusText.textContent = 'Your Community Ambassador checks for new Chatlings every 15 minutes (server-side)';
                }
            }
        }

        // Check if logged in
        async function checkAuth() {
            try {
                const response = await fetch('/api/user/me');
                if (!response.ok) {
                    window.location.href = '/user/login.html';
                } else {
                    // Check integration status after confirming auth
                    await checkIntegrationStatus();
                    // Update YouTube status if connected
                    await updateYouTubeStatus();
                }
            } catch (error) {
                window.location.href = '/user/login.html';
            }
        }

        checkAuth();
    </script>
</body>
</html>
