<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatlings - Collections</title>
    <link rel="stylesheet" href="/user/components/shared-header-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin: 0;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
        }

        .sidebar {
            min-width: 200px;
            max-width: 200px;
        }

        .main-content {
            flex: 1;
        }

        .body-type-filters {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .body-type-filters h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
        }

        .body-type-button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .body-type-button:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
        }

        .body-type-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .body-type-button:last-child {
            margin-bottom: 0;
        }

        h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .filter-bar {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }

        .filter-group select {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .collection-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chatling-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }

        .chatling-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .chatling-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            flex-shrink: 0;
        }

        .chatling-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            min-width: 150px;
            flex-shrink: 0;
        }

        .chatling-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .overall-score {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            min-width: 60px;
            text-align: center;
            flex-shrink: 0;
        }

        .score-divider {
            width: 1px;
            height: 30px;
            background: #ddd;
            margin: 0 15px;
        }

        .rarity-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 10px;
        }

        .rarity-common {
            background: #95a5a6;
            color: white;
        }

        .rarity-uncommon {
            background: #27ae60;
            color: white;
        }

        .rarity-rare {
            background: #3498db;
            color: white;
        }

        .rarity-epic {
            background: #9b59b6;
            color: white;
        }

        .rarity-legendary {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            color: white;
        }

        .encounter-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .empty-state p {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .empty-state a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        /* Trait Badges */
        .trait-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-left: auto;
            align-items: center;
        }

        .trait-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 6px 10px;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .trait-badge.high {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .trait-badge.low {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .trait-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }

        .trait-icon {
            font-size: 1.1em;
        }

        .trait-score {
            font-size: 0.9em;
            font-weight: bold;
            color: white;
        }

        .trait-name {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            margin-top: 2px;
        }

        /* Loading state for traits */
        .trait-badges-loading {
            color: #999;
            font-size: 0.85em;
            margin-left: auto;
        }

        /* Tooltip for trait badges */
        .trait-badge-tooltip {
            position: relative;
        }

        .trait-badge-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75em;
            white-space: nowrap;
            margin-bottom: 5px;
            z-index: 1000;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding: 20px;
        }

        .pagination-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .pagination-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .pagination-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #666;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <script src="/user/components/shared-header.js"></script>
    <div class="container">
        <script>initSharedHeader('collections');</script>

        <div class="content">
            <div class="sidebar">
                <div class="body-type-filters">
                    <h3>Body Types</h3>
                    <div id="body-type-buttons"></div>
                </div>
            </div>

            <div class="main-content">
                <div class="filter-bar">
                    <div class="filter-group">
                        <label for="filter-rarity">Rarity</label>
                        <select id="filter-rarity">
                            <option value="">All Rarities</option>
                            <option value="Common">Common</option>
                            <option value="Uncommon">Uncommon</option>
                            <option value="Rare">Rare</option>
                            <option value="Epic">Epic</option>
                            <option value="Legendary">Legendary</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filter-score">Overall Score</label>
                        <select id="filter-score">
                            <option value="">All Scores</option>
                            <option value="vlow">Very Low (0-20)</option>
                            <option value="low">Low (21-40)</option>
                            <option value="medium">Medium (41-60)</option>
                            <option value="high">High (61-80)</option>
                            <option value="vhigh">Very High (81-94)</option>
                            <option value="max">Max (95-100)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filter-platform">Platform</label>
                        <select id="filter-platform">
                            <option value="">All Platforms</option>
                            <option value="YouTube">YouTube</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="sort-by">Sort By</label>
                        <select id="sort-by">
                            <option value="recent">Most Recent</option>
                            <option value="rarity">Rarity</option>
                            <option value="score">Overall Score</option>
                            <option value="name">Name</option>
                        </select>
                    </div>
                </div>

                <div id="loading" class="loading">Loading your collection...</div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <h3>No Chatlings Yet!</h3>
                    <p>Start discovering chatlings by connecting your YouTube account and commenting on videos.</p>
                    <a href="integrations.html">Connect YouTube</a>
                </div>
                <div id="collection-grid" class="collection-grid"></div>
                <div id="pagination" class="pagination" style="display: none;">
                    <button class="pagination-button" id="prev-page" onclick="changePage(-1)">Previous</button>
                    <span class="pagination-info" id="page-info">Page 1</span>
                    <button class="pagination-button" id="next-page" onclick="changePage(1)">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Guide Modal -->
    <div id="guide-modal" class="modal" onclick="closeGuideModal(event)" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);">
        <div class="modal-content" onclick="event.stopPropagation()" style="position: relative; background: white; margin: 2% auto; padding: 30px; width: 90%; max-width: 800px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
            <span class="modal-close" onclick="closeGuideModal()" style="position: absolute; top: 15px; right: 20px; color: #667eea; font-size: 35px; font-weight: bold; cursor: pointer;">&times;</span>
            <h1 style="text-align: center; color: #667eea; font-size: 2em; margin-bottom: 30px;">Collections Guide</h1>

            <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                <h3 style="color: #667eea; margin-top: 0; margin-bottom: 15px;">Your Chatlings Collection</h3>
                <p style="line-height: 1.6; color: #333; margin-bottom: 15px;">
                    This is your personal collection of all the chatlings you've claimed. Each chatling is unique and represents a YouTube video you liked!
                </p>

                <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">Filtering Your Collection</h3>
                <ul style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
                    <li><strong>By Body Type:</strong> Use the sidebar to filter chatlings by their body type (Floofs, Noodles, Sleeks, etc.)</li>
                    <li><strong>By Rarity:</strong> Filter by Common, Uncommon, Rare, Epic, or Legendary</li>
                    <li><strong>By Platform:</strong> See which platform each chatling came from</li>
                </ul>

                <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">Sorting Options</h3>
                <p style="line-height: 1.6; color: #333; margin-bottom: 15px;">
                    Sort your collection by:
                </p>
                <ul style="margin-left: 20px; margin-bottom: 20px; line-height: 1.8;">
                    <li><strong>Most Recent:</strong> See your latest additions first</li>
                    <li><strong>Rarity:</strong> View your rarest chatlings at the top</li>
                    <li><strong>Name:</strong> Alphabetical order by chatling name</li>
                </ul>

                <h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">Viewing Details</h3>
                <p style="line-height: 1.6; color: #333; margin-bottom: 15px;">
                    Click on any chatling card to view its full details, including all 8 social trait scores and a larger image.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Guide modal functions
        function openGuideModal() {
            const modal = document.getElementById('guide-modal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeGuideModal(event) {
            if (event && event.target.id !== 'guide-modal' && event.target.className !== 'modal-close') {
                return;
            }
            const modal = document.getElementById('guide-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
    </script>

    <script>
        let allChatlings = [];
        let filteredChatlings = [];
        let selectedBodyType = '';
        let currentPage = 1;
        const CREATURES_PER_PAGE = 20;

        async function loadBodyTypes() {
            try {
                const response = await fetch('/api/body-types');
                if (response.ok) {
                    const bodyTypes = await response.json();
                    const container = document.getElementById('body-type-buttons');
                    container.innerHTML = '';

                    bodyTypes.forEach((type, index) => {
                        const button = document.createElement('button');
                        button.className = 'body-type-button';
                        if (index === 0) {
                            button.classList.add('active');
                            selectedBodyType = type.display_name;
                        }
                        button.textContent = type.display_name;
                        button.onclick = () => filterByBodyType(type.display_name);
                        container.appendChild(button);
                    });
                }
            } catch (error) {
                console.error('Error loading body types:', error);
            }
        }

        function filterByBodyType(bodyType) {
            selectedBodyType = bodyType;

            // Update button active states
            const buttons = document.querySelectorAll('.body-type-button');
            buttons.forEach(btn => {
                if (btn.textContent === bodyType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            currentPage = 1;
            filterAndSort();
        }

        function changePage(direction) {
            currentPage += direction;
            displayCurrentPage();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function displayCurrentPage() {
            const start = (currentPage - 1) * CREATURES_PER_PAGE;
            const end = start + CREATURES_PER_PAGE;
            const pageCreatures = filteredChatlings.slice(start, end);

            displayChatlings(pageCreatures);
            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredChatlings.length / CREATURES_PER_PAGE);
            const paginationDiv = document.getElementById('pagination');
            const pageInfo = document.getElementById('page-info');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');

            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
            } else {
                paginationDiv.style.display = 'flex';
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = currentPage === totalPages;
            }
        }

        async function loadCollection() {
            try {
                const response = await fetch('/api/user/collection');
                if (response.ok) {
                    allChatlings = await response.json();
                    if (allChatlings.length === 0) {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('empty-state').style.display = 'block';
                    } else {
                        document.getElementById('loading').style.display = 'none';
                        // Apply filters (including default first body type)
                        filterAndSort();
                    }
                } else {
                    // Not logged in - redirect
                    window.location.href = '/user/login.html';
                }
            } catch (error) {
                console.error('Error loading collection:', error);
                window.location.href = '/user/login.html';
            }
        }

        function displayChatlings(chatlings) {
            const grid = document.getElementById('collection-grid');
            grid.innerHTML = '';

            chatlings.forEach(chatling => {
                const card = document.createElement('div');
                card.className = 'chatling-card';
                card.onclick = () => window.location.href = `view-chatling.html?id=${chatling.id}`;

                // Handle null or missing images
                const hasImage = chatling.selected_image && chatling.selected_image !== 'null';
                const imageSrc = hasImage ? `/thumbs/${chatling.selected_image}` : '';
                const imageFallback = hasImage ? `/images/${chatling.selected_image}` : '';

                card.innerHTML = `
                    <img src="${imageSrc}"
                         alt="${chatling.creature_name}"
                         class="chatling-image"
                         onerror="if(this.src !== '${imageFallback}') this.src='${imageFallback}'; else this.style.display='none';"
                         style="${!hasImage ? 'display:none;' : ''}">
                    <div class="chatling-name">${chatling.creature_name}</div>
                    <div class="overall-score">${chatling.overall_score || 0}</div>
                    <div class="score-divider"></div>
                    <div id="traits-${chatling.id}" class="trait-badges-loading">Loading...</div>
                `;

                grid.appendChild(card);

                // Load trait scores asynchronously
                loadTraitScores(chatling.id);
            });
        }

        async function loadTraitScores(creatureId) {
            try {
                const response = await fetch(`/api/creature/${creatureId}/traits`);
                if (response.ok) {
                    const traits = await response.json();
                    displayTraitBadges(creatureId, traits);
                } else {
                    document.getElementById(`traits-${creatureId}`).style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading traits:', error);
                document.getElementById(`traits-${creatureId}`).style.display = 'none';
            }
        }

        function displayTraitBadges(creatureId, traits) {
            const container = document.getElementById(`traits-${creatureId}`);
            if (!container) return;

            container.className = 'trait-badges';
            container.innerHTML = '';

            // Filter for very highs (81-100) and very lows (0-20)
            const highs = traits.filter(t => t.score >= 81);
            const lows = traits.filter(t => t.score <= 20);

            // Show highs first (green)
            highs.forEach(trait => {
                const badge = document.createElement('div');
                badge.className = 'trait-badge high trait-badge-tooltip';
                badge.setAttribute('data-tooltip', `${trait.category_name}: ${trait.score}`);

                badge.innerHTML = `
                    <span class="trait-icon">${trait.icon}</span>
                    <span class="trait-score">${trait.score}</span>
                `;

                container.appendChild(badge);
            });

            // Show lows (red)
            lows.forEach(trait => {
                const badge = document.createElement('div');
                badge.className = 'trait-badge low trait-badge-tooltip';
                badge.setAttribute('data-tooltip', `${trait.category_name}: ${trait.score}`);

                badge.innerHTML = `
                    <span class="trait-icon">${trait.icon}</span>
                    <span class="trait-score">${trait.score}</span>
                `;

                container.appendChild(badge);
            });

            // If no extreme scores, show a message
            if (highs.length === 0 && lows.length === 0) {
                container.innerHTML = '<span style="color: #999; font-size: 0.85em;">Moderate scores</span>';
            }
        }

        function filterAndSort() {
            const rarity = document.getElementById('filter-rarity').value;
            const scoreRange = document.getElementById('filter-score').value;
            const platform = document.getElementById('filter-platform').value;
            const sortBy = document.getElementById('sort-by').value;

            let filtered = allChatlings;

            // Filter by body type
            if (selectedBodyType) {
                filtered = filtered.filter(c => c.body_type_name === selectedBodyType);
            }

            // Filter by rarity
            if (rarity) {
                filtered = filtered.filter(c => c.rarity_tier === rarity);
            }

            // Filter by overall score range
            if (scoreRange) {
                filtered = filtered.filter(c => {
                    const score = c.overall_score || 0;
                    switch (scoreRange) {
                        case 'vlow': return score >= 0 && score <= 20;
                        case 'low': return score >= 21 && score <= 40;
                        case 'medium': return score >= 41 && score <= 60;
                        case 'high': return score >= 61 && score <= 80;
                        case 'vhigh': return score >= 81 && score <= 94;
                        case 'max': return score >= 95 && score <= 100;
                        default: return true;
                    }
                });
            }

            // Filter by platform
            if (platform) {
                filtered = filtered.filter(c => c.platform === platform);
            }

            // Sort
            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'recent':
                        return new Date(b.claimed_at) - new Date(a.claimed_at);
                    case 'rarity':
                        const rarityOrder = { 'Legendary': 5, 'Epic': 4, 'Rare': 3, 'Uncommon': 2, 'Common': 1 };
                        return (rarityOrder[b.rarity_tier] || 0) - (rarityOrder[a.rarity_tier] || 0);
                    case 'score':
                        return (b.overall_score || 0) - (a.overall_score || 0);
                    case 'name':
                        return a.creature_name.localeCompare(b.creature_name);
                    default:
                        return 0;
                }
            });

            filteredChatlings = filtered;
            currentPage = 1;
            displayCurrentPage();
        }

        // Event listeners
        document.getElementById('filter-rarity').addEventListener('change', filterAndSort);
        document.getElementById('filter-score').addEventListener('change', filterAndSort);
        document.getElementById('filter-platform').addEventListener('change', filterAndSort);
        document.getElementById('sort-by').addEventListener('change', filterAndSort);

        // Load collection and body types on page load
        loadCollection();
        loadBodyTypes();
    </script>
</body>
</html>
