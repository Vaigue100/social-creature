<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creature Card with Traits</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .creature-card-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .creature-card-container {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .creature-card-container {
                padding: 15px;
            }
        }

        .creature-title {
            text-align: center;
            color: #667eea;
            font-size: 2em;
            margin-bottom: 30px;
        }

        .creature-display {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 500px;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Container for image with traits beside it - scales as one unit */
        .image-with-traits {
            display: flex;
            align-items: stretch;
            gap: 0;
            flex-direction: row-reverse;
            max-width: 100%;
            max-height: 80vh;
            width: fit-content;
            margin: 0 auto;
            position: relative;
        }

        /* Rarity badge in top right corner */
        .rarity-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .rarity-common {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .rarity-uncommon {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .rarity-rare {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .rarity-epic {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }

        .rarity-legendary {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            animation: legendaryGlow 2s ease-in-out infinite;
        }

        @keyframes legendaryGlow {
            0%, 100% { box-shadow: 0 4px 12px rgba(243, 156, 18, 0.5); }
            50% { box-shadow: 0 4px 20px rgba(243, 156, 18, 0.8); }
        }

        /* Traits column on left side with unified background */
        .traits-column {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 210px;
            min-width: 160px;
            max-width: 210px;
            padding: 15px;
            flex-shrink: 1;
            border-radius: 15px 0 0 15px;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.2);
            /* Background gradient will be set via JavaScript */
        }

        .creature-image {
            display: block;
            width: auto;
            height: auto;
            max-width: calc(100% - 210px);
            max-height: 80vh;
            min-width: 200px;
            border-radius: 0 15px 15px 0;
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.2);
            object-fit: contain;
            flex-shrink: 2;
        }

        /* Individual trait badge - no background */
        .trait-badge-horizontal {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            transition: transform 0.2s, padding 0.2s;
            cursor: pointer;
            position: relative;
            margin: 0;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .trait-badge-horizontal:hover {
            transform: translateX(-3px);
            background: rgba(255, 255, 255, 0.25);
        }

        /* Compact mode - hide trait names and reduce column width */
        .traits-column.compact-mode {
            width: 105px;
            min-width: 80px;
            max-width: 105px;
            padding: 10px;
        }

        .trait-badge-horizontal.compact .trait-name {
            display: none;
        }

        .trait-badge-horizontal.compact {
            padding: 6px 8px;
            justify-content: space-between;
            gap: 10px;
        }

        .trait-badge-horizontal.compact .trait-left {
            gap: 10px;
            flex: 0;
        }

        .trait-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .trait-icon {
            font-size: 1.2em;
            flex-shrink: 0;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        .trait-name {
            color: white;
            font-weight: 600;
            font-size: 0.85em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .trait-score {
            color: white;
            font-weight: bold;
            font-size: 1em;
            min-width: 28px;
            text-align: right;
            flex-shrink: 0;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Tooltip - appears below badge */
        .trait-badge-horizontal::after {
            content: attr(data-tooltip);
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .trait-badge-horizontal:hover::after {
            opacity: 1;
        }

        /* Hide loading when traits are displayed */
        .traits-column:not(:empty) ~ .loading {
            display: none;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .traits-column {
                width: 180px;
                min-width: 140px;
                max-width: 180px;
                padding: 12px;
            }

            .traits-column.compact-mode {
                width: 90px;
                min-width: 70px;
                max-width: 90px;
            }

            .creature-image {
                max-width: calc(100% - 180px);
            }

            .trait-badge-horizontal {
                padding: 6px 8px;
            }

            .trait-name {
                font-size: 0.8em;
            }
        }

        @media (max-width: 768px) {
            .creature-display {
                padding: 10px;
            }

            .traits-column {
                width: 140px;
                min-width: 120px;
                max-width: 140px;
                padding: 10px;
            }

            .traits-column.compact-mode {
                width: 70px;
                min-width: 60px;
                max-width: 70px;
            }

            .creature-image {
                max-width: calc(100% - 140px);
                min-width: 150px;
            }

            .trait-badge-horizontal {
                padding: 5px 7px;
            }

            .trait-name {
                font-size: 0.7em;
            }

            .trait-icon {
                font-size: 1em;
            }

            .trait-score {
                font-size: 0.85em;
            }
        }

        @media (max-width: 480px) {
            .traits-column {
                width: 100px;
                min-width: 100px;
                max-width: 100px;
                padding: 8px;
            }

            .traits-column.compact-mode {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
                padding: 6px;
            }

            .creature-image {
                max-width: calc(100% - 100px);
                min-width: 120px;
            }

            .trait-badge-horizontal {
                padding: 4px 6px;
            }

            .trait-badge-horizontal.compact {
                padding: 3px 5px;
            }

            .trait-name {
                font-size: 0.65em;
            }

            .trait-icon {
                font-size: 0.9em;
            }

            .trait-score {
                font-size: 0.75em;
            }

            .creature-title {
                font-size: 1.5em;
            }
        }

        .refresh-button {
            display: block;
            margin: 20px auto 0;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .refresh-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
    </style>
</head>
<body>
    <div class="creature-card-container">
        <h1 class="creature-title" id="creature-name">Loading...</h1>

        <div class="creature-display">
            <div class="image-with-traits">
                <div class="rarity-badge" id="rarity-badge" style="display: none;"></div>
                <img id="creature-image" class="creature-image" src="" alt="Creature" style="display: none;">
                <div class="traits-column" id="traits-container">
                    <div class="loading">Loading traits...</div>
                </div>
                <div class="loading" id="image-loading">Loading image...</div>
            </div>
        </div>

        <button class="refresh-button" onclick="loadRandomCreature()">ðŸŽ² Load Random Creature</button>
    </div>

    <script>
        let currentCreature = null;

        async function loadRandomCreature() {
            try {
                // Get random creature with image
                const response = await fetch('/api/random-creature-with-traits');
                if (!response.ok) {
                    throw new Error('Failed to fetch creature');
                }

                const data = await response.json();
                currentCreature = data;

                // Update title
                document.getElementById('creature-name').textContent = data.creature_name;

                // Update rarity badge
                const rarityBadge = document.getElementById('rarity-badge');
                if (data.rarity_tier) {
                    rarityBadge.textContent = data.rarity_tier;
                    rarityBadge.className = 'rarity-badge rarity-' + data.rarity_tier.toLowerCase();
                    rarityBadge.style.display = 'block';
                } else {
                    rarityBadge.style.display = 'none';
                }

                // Update image
                const img = document.getElementById('creature-image');
                const imgLoading = document.getElementById('image-loading');
                img.src = `/images/${data.selected_image}`;
                img.style.display = 'block';
                imgLoading.style.display = 'none';

                // Render traits
                renderTraitsVertical(data.traits, data.primary_color);

            } catch (error) {
                console.error('Error loading creature:', error);
                document.getElementById('creature-name').textContent = 'Error loading creature';
            }
        }

        function renderTraitsVertical(traits, baseColor) {
            const container = document.getElementById('traits-container');

            // Clear loading state
            const imgLoading = document.getElementById('image-loading');
            if (imgLoading) {
                imgLoading.style.display = 'none';
            }

            // Clear container
            container.innerHTML = '';
            container.style.display = 'flex';

            // Parse base color or use default
            const color = baseColor || '#667eea';

            // Apply unified gradient background to the entire column
            const columnGradient = createColumnGradient(color);
            container.style.background = columnGradient;

            // Sort by category order
            const sortedTraits = [...traits].sort((a, b) => a.category_id - b.category_id);

            sortedTraits.forEach((trait, index) => {
                const badge = document.createElement('div');
                badge.className = 'trait-badge-horizontal';

                // Add tooltip
                badge.setAttribute('data-tooltip', trait.description);

                badge.innerHTML = `
                    <div class="trait-left">
                        <span class="trait-icon">${trait.icon}</span>
                        <span class="trait-name">${trait.category_name}</span>
                    </div>
                    <span class="trait-score">${trait.score}</span>
                `;

                container.appendChild(badge);
            });

            // Set up resize observer to toggle compact mode
            setupResizeObserver();
        }

        function createColumnGradient(baseColor) {
            // Convert hex to RGB
            const hex = baseColor.replace('#', '');
            let r = parseInt(hex.substr(0, 2), 16);
            let g = parseInt(hex.substr(2, 2), 16);
            let b = parseInt(hex.substr(4, 2), 16);

            // Create gradient from lighter to darker
            const r1 = Math.min(255, Math.round(r * 1.2));
            const g1 = Math.min(255, Math.round(g * 1.2));
            const b1 = Math.min(255, Math.round(b * 1.2));

            const r2 = Math.max(0, Math.round(r * 0.7));
            const g2 = Math.max(0, Math.round(g * 0.7));
            const b2 = Math.max(0, Math.round(b * 0.7));

            return `linear-gradient(180deg, rgb(${r1}, ${g1}, ${b1}) 0%, rgb(${r2}, ${g2}, ${b2}) 100%)`;
        }

        function setupResizeObserver() {
            const img = document.getElementById('creature-image');
            const traitsColumn = document.getElementById('traits-container');

            if (!img || !traitsColumn) return;

            let debounceTimer = null;
            let lastMode = null;

            // Check and update badge display mode
            function checkBadgeSize() {
                const imgWidth = img.offsetWidth;
                const badges = traitsColumn.querySelectorAll('.trait-badge-horizontal');

                // Get the current column width based on whether it's in compact mode
                const isCurrentlyCompact = traitsColumn.classList.contains('compact-mode');
                const currentTraitsWidth = isCurrentlyCompact ? 105 : 210; // Use actual widths

                // Calculate ratio based on actual widths
                const ratio = currentTraitsWidth / imgWidth;

                // Use hysteresis to prevent flickering
                let shouldBeCompact;
                if (isCurrentlyCompact) {
                    // Harder to exit compact mode - need to be under 40%
                    shouldBeCompact = ratio > 0.4;
                } else {
                    // Easier to enter compact mode - over 50%
                    shouldBeCompact = ratio > 0.5;
                }

                // Only update if mode changed
                if (shouldBeCompact !== isCurrentlyCompact && shouldBeCompact !== lastMode) {
                    lastMode = shouldBeCompact;

                    badges.forEach(badge => {
                        if (shouldBeCompact) {
                            badge.classList.add('compact');
                        } else {
                            badge.classList.remove('compact');
                        }
                    });

                    if (shouldBeCompact) {
                        traitsColumn.classList.add('compact-mode');
                    } else {
                        traitsColumn.classList.remove('compact-mode');
                    }
                }
            }

            // Debounced check
            function debouncedCheck() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(checkBadgeSize, 100);
            }

            // Check on window resize
            window.addEventListener('resize', debouncedCheck);

            // Initial check
            setTimeout(checkBadgeSize, 200);

            // Also check when image loads
            img.addEventListener('load', () => {
                setTimeout(checkBadgeSize, 100);
            });
        }


        // Load random creature on page load
        loadRandomCreature();
    </script>
</body>
</html>
